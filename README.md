# ino2ubi

**Версия:** 1.7.2

Скрипт для конвертации Arduino скетчей (.ino) в пользовательские блоки (.ubi) для программы FLProg. Позволяет автоматически создавать переиспользуемые блоки из Arduino кода с поддержкой входных/выходных параметров, переменных и пользовательских функций.

## Описание

- **Парсинг Arduino скетчей** с автоматическим определением:
  - Глобальных переменных (int, float, bool, String и др.)
  - Пользовательских функций (кроме setup/loop)
  - Директив `#include` и `#define`
  - Объектов классов (например, SoftwareSerial)

- **Настройка ролей переменных:**
  - `variable` — внутренняя переменная блока
  - `input` — входной параметр (отображается слева на блоке)
  - `output` — выходной параметр (отображается справа на блоке)
  - `parameter` — настраиваемый параметр блока

- **Генерация XML** в формате SIXX для FLProg
- **GUI** на PyQt5
- **CLI** для автоматизации

## Использование

### GUI режим

```bash
python arduino_to_flprog_GLOBAL_COMPLETE.py
```

1. Загрузите .ino файл или вставьте код Arduino
2. Нажмите «Парсить код» для анализа
3. Настройте переменные (двойной клик для редактирования):
   - Выберите роль (variable/input/output/parameter)
   - Установите псевдоним (имя в блоке FLProg)
   - Задайте значение по умолчанию
4. Настройте название и описание блока
5. Нажмите «Сгенерировать .ubi блок»
6. Сохраните файл .ubi

### CLI режим

```bash
python arduino_to_flprog_GLOBAL_COMPLETE.py -i sketch.ino
python arduino_to_flprog_GLOBAL_COMPLETE.py -i sketch.ino -o myblock.ubi
python arduino_to_flprog_GLOBAL_COMPLETE.py -i sketch.ino -n "MyBlock" -d "Описание блока"
```

**Параметры:** `-i` (input), `-o` (output), `-n` (name), `-d` (description)

## Пример Arduino кода

```cpp
// Описание блока (автоматически используется как описание)
int sensorValue = 0;  // in — входной параметр
int outputValue = 0;  // out — выходной параметр
int threshold = 100;  // par — настраиваемый параметр

void setup() {
  Serial.begin(9600);
}

void loop() {
  sensorValue = analogRead(A0);
  if (sensorValue > threshold) {
    outputValue = 1;
  } else {
    outputValue = 0;
  }
}
```

## Примечания

- Комментарии в начале скетча (`//` или `/* */`) автоматически используются как описание блока
- Роли переменных определяются по комментариям: `//in`, `//out`, `//par`
- Роль define определяются по комментарию: `//par`
- Функции setup() и loop() автоматически извлекаются в соответствующие секции блока
- Пользовательские функции добавляются в секцию functionCodePart
- Директивы `#include` и `#define` сохраняются в declareCodePart
- Объекты классов (например SoftwareSerial) сохраняются как дополнительные декларации и не отображаются в таблице переменных

## Иконка

Положите файл `icon.ico` в папку со скриптом — он будет использоваться как иконка окна и как иконка exe при сборке через PyInstaller. Формат: .ico (рекомендуется 32×32 и 256×256).

## Требования

- Python 3.10+
- PyQt5 (`pip install PyQt5`)

## Структура проекта

| Файл | Назначение |
|------|------------|
| `launcher.py` | Launcher для exe (только при сборке) |
| `arduino_to_flprog_GLOBAL_COMPLETE.py` | Точка входа (GUI/CLI) |
| `constants.py` | Константы, версия, маппинг типов |
| `parser.py` | Парсинг Arduino кода |
| `generator.py` | Генерация SIXX XML для FLProg |
| `gui.py` | Графический интерфейс PyQt5 |
| `README.md` | Документация и справка |
| `CHANGELOG.md` | История изменений |
| `build_exe.bat` | Сборка exe (двойной клик) |

## Проверка обновлений

При запуске из exe приложение автоматически проверяет наличие новых версий на GitHub. Меню **Справка → Проверить обновления** — ручная проверка. Обновления не устанавливаются автоматически: пользователь скачивает релиз с [GitHub Releases](https://github.com/phazz1980/ino2ubi/releases) и заменяет файлы.

## Сборка EXE

Запустите `build_exe.bat` (двойной клик) или:
```bash
pyinstaller arduino_to_flprog_GLOBAL_COMPLETE.spec --noconfirm --distpath .
```
Exe `ino2ubi.exe` и .py файлы — в корне проекта. Пересборка exe не нужна при изменении .py; достаточно заменить скрипты.

## История изменений (Changelog)

### v1.7.2
- Порядок расположения входов, выходов и параметров зависит от того местонахождения переменной или define в коде
- Генератор кода улучшен теперь блоки содержат меньше ошибок (возможно не будет падать в версии ниже 9)
- Парсер автоматически определяет тип переменной если Define используется в качестве параметра
- Исправлено добавление параметра из Define в блок
- Исправлена обработка static

### v1.6
- Добавлен определение макроса define в качестве параметра работает также по комметрарию //par
- Исправлена работа со структурами
- Устранены падения при открытии окна выбора файла
- Загрузка обновления теперь загружает сразу архив программы (опционально)

### v1.5
- Исправлена проверка обновлений: fallback SSL-контекста в exe на Windows (когда `create_unverified_context` недоступен)
- Обработка 404: понятное сообщение при отсутствии релизов на GitHub

### v1.4
- **Launcher exe:** exe — только загрузчик; gui, parser, generator, constants — отдельные .py
- **Проверка обновлений:** меню «Справка → Проверить обновления», авто-проверка при запуске (только exe)
- Exe в корне проекта, имя `ino2ubi.exe` без версии
- `build_exe.bat` с `cd /d "%~dp0"` для запуска двойным кликом

### v1.3
- **Модульная структура:** код разделён на `arduino_to_flprog_GLOBAL_COMPLETE.py` (точка входа), `gui.py`, `generator.py`, `parser.py`, `constants.py`
- **Справка в GUI:** меню «Справка» (F1), окно «О программе»; текст справки загружается из `README.md`
- **Разметка:** вкладки «Переменные» и «Функции» занимают 75% высоты правой панели


### v1.2
- Начальная версия с GUI и CLI

### v1.0
- Первая версия конвертера Arduino → FLProg

---
